services:
  - docker

env:
  global:
    - DOCKER_COMPOSE_VERSION=1.23.2
    - secure: "VC7S2Hmot7fbuLr+nDNeXQXsIqQGCAm3K88FWmovjq5pL7gLSgHUCRj4+gyW2PxFKuvo/kFlEMmfcqt/mF8DgS3vt++G+3BRsD6KStOmdTwRM5Flooj0BjtJSQCOJ6E73IBjBMynZlH4gXYXC328eShpdJQ0BtDBO5C9w/ur4I37aw3A68Q5scfutFdRpSbdszuIiZDqvCNGlpfoPYNApw5bw7oGX68PybqiNldnwNpkHO90+aYxF785hJ/2qe4U1P+GqQTZMl60bmg6cup3I01j38b6K+AaG9fAErs7/DXsQFb6+OYxCpDYFXhfmYLAimUvM7O9doZMUGP+n+U0b40lYTq4q1HySsQoBje6IFolBC4OeY4hFDWc/KzZBFl80ZwtIOupwiaUeW+02jkE9IU/98FWhVfWFxZ53HMYWprbTR1Psq2y7UQwNjrzO5E947H8EGbzCR2KdFhfXvhuN+h4Quy/C3XJGgeYoC/4pW6ZGpQszFtarqg6g8Fh5dPCBguWCaG0IcDDhYGQEXKcqPm32RXB1N5OhmYZmbtjDyawG8aDmZ11jn8KgLO/VSLl0J6rQAy007ADu6yMPuHE5igl7hu9NGWF6pvMI0K/v0fCtP2FH/VQtfju9ubfOTUabnGDHOZaDiU4oLIpfNz2215St1EZwgVRKjxkU7jUL0o="
    - secure: "U0AaLqOHDCGXqhSoGF1WFCGhQhB4NIcqzva5bhNtEZ2Puy0+Fr4oJzX/18VyAPoTcUSE6Z6Tco1z4ec7Q4RiMHS6k4IxUJZCiwmfGEOHaKo9ukYSU8FICmKNibuhuIRd2Jge6ZuP70KMwSGRAJo5rD/oybS7McKC1aRnqlfL71EdDdJoZj7UrYZzt34ga2j1CWNrFIQIEFHNnJCiyW50YNiPgaRJBVW+mkIqlyPEjU5BqFV4bkBpKBZSgQsUCHrm6s+23uiCbUw3joDs6u8Vr9pCsebBp2xXQpWBffPwkaxm6wNz/Km36cMBATvEa+x/TptGFG8Tfu2S/czw+0sPEzZO2DokfdJnneq5CRZpssoB/FY22mRm6ql8tXemW96kw0Ss5Rb+4bXDZaQNJbDgW9k0yARJKcmv6f8GH/JN2DRrDkogAFN1N63z3skM7+y0YUi82KzGiF3j4khxv5RB4IZ0m7XKvFmE58/tn6TS61dJtuQb4u2gPrq1E14SPxEVRJTyorzffUUj8q2Tg9MZnHvHrxbyPK/LaUlOZRs/OIif10vkPUZBQ7thK4szkN6Fkvld4ZF2jz0J6Dp7dD0xfwh3s/9O2XiXVgC10yciEiM3g9txqY9CDKi4N/oHdarXQnfny0+i+LYcVqYgetQEFBBFFP0CTS/+uWLfh2u1PgU="

before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - docker --version
  - docker-compose version
  - echo "Login into Docker Hub"
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - export GIT_SHA=`git rev-parse --short HEAD`
  - echo "Building commit $GIT_SHA"

jobs:
  include:
    - stage: tests
      name: "Unit Tests"
      script:
      - cd ch4
      - docker-compose build db
      - docker-compose build test-postgresql
      - docker-compose run test-postgresql
    - stage: tests
      name: "Static Analysis"
      script:
      - cd ch4
      - docker-compose build static-analysis
      - docker-compose run static-analysis
    - stage: push
      script:
      - cd ch4
      - docker-compose build server
      - docker tag thoughts_server:latest majeformation/jd-thoughts-backend:$GIT_SHA
      - docker push jaimebuelta/thoughts-backend:$GIT_SHA
      - docker tag thoughts_server:latest majeformation/jd-thoughts-backend:$TRAVIS_BRANCH
      deploy:
      - provider: script
        script: docker push majeformation/jd-thoughts-backend:$TRAVIS_BRANCH
        on:
          branch: master        
      - provider: script
        script: docker push majeformation/jd-thoughts-backend:$TRAVIS_TAG
        on:
          tags: True
