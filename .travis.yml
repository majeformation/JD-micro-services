services:
- docker
env:
  global:
  - DOCKER_COMPOSE_VERSION=1.23.2
  - secure: hio7jGlgwDi8MwTNMY0HSWfRv+DtDKPUt1dvKtT58ItsOZxXbtTnoaaO0dQY61eAATXxhZIluK2/QbNCAAiId3iD9HYNA0J2H7Bqe2cYjVkiA7Oo9jRyW9tYMTnWTJ05utCRisq2Pb/PTRkK/9YZFUirt1IxZRozpWV6iUOZiAHn3NXTEpJFWjKH1+r6lMqStQ9BJM6I+SDDesgk6nCA5OTBM2kvi3iZ3OLrKjr607AH2xjBq0gSB/LLTFP2DVaxkOMqWQ0H2hRTVHoulngtDwGhXdXytP5igG8+hZXqY66AaCDU589UGdqADu39tI1JkHF1+oK5eO81vJ+VehBpHigx+suxamV7TCE8vv9cBWa2iyJb7XqNq4/b+qu6LbJ9cpMFUVq8XwAa1MUXA4sAUL62RBzZVxCtpIoX7rx7tepvnpHNXpQGmIdOR/hqLfqr12g0Zvy/Hp4WHQWxOQ/Bu3gZ1EK8g+K6MIxNx8CTODEbpkQO2/r/sI/Jg8dvzuPHxdaER6MVzOiII7jpmUL9ZvHX6EP1gYfHl7BptiBBSDzSnyBK1KDRo/cacJ3Srfw+q+bego6T8Mn5+Zp5Fbbf//tGYrSwTtblkCXS0SsHjLTlAUIWoXSzGYpW9PcbCu+oRVvKFjAt2+evN7b8WXFa0K/KqDg5dBLhfX9ls8PuYyI=
  - secure: qJETG46pBKYdRtNebzwAxdLUz/F+P2g9GjSMSPm9STz3ZeLv6C1OfVPSDzXubCQ42bnqFpJnfuSAS6whU/82gyFEa0HZ7LUJ/l5/g2Aay+BXEJJ8xrcbOrZ37fI0uZLOU2Z5xJvz4y/gzhj4grb0b6zRDAynyknjvc1yDQA6fnQ8gvJUl6g8/wZpJif8+5vAOfi2CwVIyKxKo0qwYUuLvOQfcim/2zXtbZGCut1jVaQC3tuK3sy48ZThtA8MdxvWfI0hHqDhKqYhh0KIjnCZh8G0t6UllWOKTxeyl7ROA4r/RnLW4L8NVtT8VMWzU+mWyFwQAcArYgZsfO5rAcS2ze7EOd4rYtjXlJv5+5EKdwfaFp2cpYLD58sDN60Abpmdzlx4Z4fMYKCCpzZ0xTQNM7BIvthmwvvIJRhdQTTwyDZMtY6o7w7vzJuNghrxHQHednbWTy4qLL/b3O5AZx92g57KO4kcfDzfYkOjiUB/RpewNOaG+VkgnHBfA9FwDnPbexxjw5HawWsbnpY2Rs1RkU8YHApSyUkcBrzEz2Pnc3ik/fSRfKo2JM9GJAatP+Ip/b0l+TxAo3UuhxeugkdIRyAmYnhZJG67QV+vACn2YdroVkX9N6K94l5fvryleQJOhG8nxjZ0j9p9woCKRgz4H60/EW8t7DpYGwUrYByK3Sc=
before_install:
- sudo rm /usr/local/bin/docker-compose
- curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname
  -s`-`uname -m` > docker-compose
- chmod +x docker-compose
- sudo mv docker-compose /usr/local/bin
- docker --version
- docker-compose version
- echo "Login into Docker Hub"
- echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
- export GIT_SHA=`git rev-parse --short HEAD`
- echo "Building commit $GIT_SHA"
jobs:
  include:
  - stage: tests
    name: Unit Tests
    script:
    - cd Chapter04
    - docker-compose build db
    - docker-compose build test-postgresql
    - docker-compose run test-postgresql
  - stage: tests
    name: Static Analysis
    script:
    - cd Chapter04
    - docker-compose build static-analysis
    - docker-compose run static-analysis
  - stage: push
    script:
    - cd Chapter04
    - docker-compose build server
    - docker tag thoughts_server:latest majeformation/jd-thoughts-backend:$GIT_SHA
    - docker push majeformation/jd-thoughts-backend:$GIT_SHA
    - docker tag thoughts_server:latest majeformation/jd-thoughts-backend:$TRAVIS_BRANCH
    deploy:
    - provider: script
      script: docker push majeformation/jd-thoughts-backend:$TRAVIS_BRANCH
      on:
        branch: master
    - provider: script
      script: docker push majeformation/jd-thoughts-backend:$TRAVIS_TAG
      on:
        tags: true
